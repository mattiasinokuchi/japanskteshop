<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{pageTitle}}</title>
  </head>
  <body>
    {{> header}}
    <p>{{description}}</p>
    <p>Pris {{price}} kr per förpackning</p>
    <form name="ShoppingList">
      <fieldset>
        <p>Antal i korgen: </p>
        <label id="amountLabel">0</label>
        <input type="button" value="Lägg i" onclick="addItem()">
        <input type="button" value="Lägg tillbaka" onclick="removeItem()">
      </fieldset>
      <div id="items_table">
        <h2>I korgen:</h2>
        <table id="list"></table>
        <label id="sumOfItems">0</label>
      </div>
    </form>
    {{> footer}}
    <script>

      const label = document.querySelector("#amountLabel");
      const name = "{{pageTitle}}";
      const price = {{price}};
      const sku = "{{sku}}";
      let sumOfRow = "";
      let sumOfItems = "";
      let grandTotal = "";

      //call function to show table for shopping
      window.load=doShowAll();

      //populate table and label with items
      function doShowAll() {
        let key = "";
        let list = "<tr><th></th><th>Antal</th></tr>\n";
        let i = 0;
        //For a more advanced feature, you can set a cap on max items in the cart.
        for (i = 0; i <= localStorage.length-1; i++) {
          key = localStorage.key(i);
          list += "<tr><td>" + key + "</td>\n<td>"
          + JSON.parse(localStorage.getItem(key))[0] + "</td></tr>\n";
        }
        //if no item exists in the cart.
        if (list == "<tr><th></th><th>Antal</th></tr>\n") {
          list += "<tr><td><i></i></td>\n<td><i></i></td></tr>\n";
        }
        //bind amount to HTML table.
        document.getElementById('list').innerHTML = list;
        //populate label with amount
        if (localStorage.getItem("{{pageTitle}}") !=null) {
          label.textContent = JSON.parse(localStorage.getItem("{{pageTitle}}"))[0];
        } else {
          label.textContent = "0";
        }
      }

      //function to add an item
      function addItem() {
        let amount = label.textContent;
        sumOfItems = 0;
        grandTotal = 0;
        amount++;
        if (amount < 1) {
          amount = 1;
        }
        sumOfRow = amount*price;
        localStorage.setItem(name, JSON.stringify([amount, price, sumOfRow, sku]));
        //loop for counting items
        for (i = 0; i <= localStorage.length-1; i++) {
          key = localStorage.key(i);
          sumOfItems+= parseInt(JSON.parse(localStorage.getItem(key))[0]);
          grandTotal+= parseInt(JSON.parse(localStorage.getItem(key))[2]);
        }
        doShowAll();
      }
      //function to remove an item
      function removeItem() {
        let amount = label.textContent;
        sumOfItems = 0;
        grandTotal = 0;
        amount--;
        if (amount < 1) {
          localStorage.removeItem(name);
        } else {
          sumOfRow = amount*price;
          localStorage.setItem(name, JSON.stringify([amount, price, sumOfRow, sku]));
        }
        //loop for counting items
        for (i = 0; i <= localStorage.length-1; i++) {
          key = localStorage.key(i);
          sumOfItems+= parseInt(JSON.parse(localStorage.getItem(key))[0]);
          grandTotal+= parseInt(JSON.parse(localStorage.getItem(key))[2]);
        }
        doShowAll();
      }
    </script>
  </body>
</html>
